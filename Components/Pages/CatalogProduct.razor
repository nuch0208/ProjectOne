@page "/catalog/{CategoryId:int}"
@using System.Net.Http.Json
@using Blazored.LocalStorage
@inherits LayoutComponentBase
@layout ProjectOne.Components.Layout.MinimalLayout
@rendermode InteractiveServer
@inject IHttpClientFactory HttpClientFactory
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject ILocalStorageService LocalStorage

<div class="landing">

    <!-- TOP NAV -->
    <header class="topnav">
        <div class="container-xl topnav-inner">
            <a class="brand" href="/product">
                <span class="brand-dot"></span>
                <span class="brand-text">CU Madical Co.,Ltd.</span>
            </a>

            <nav class="navlinks d-none d-md-flex">
                <a href="/product#home">Home</a>
                <a href="/product#products">About</a>
                <a href="/catalog" class="active">Product</a>
                <a href="/product#contact">Contact us</a>
            </nav>

            <button class="btn btn-outline-light d-md-none ms-auto" type="button"
                    data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
                ‚ò∞
            </button>
        </div>
    </header>

    <!-- MOBILE MENU -->
    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="mobileMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Menu</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-grid gap-2">
                <a class="btn btn-outline-light" href="/product#home" data-bs-dismiss="offcanvas">Home</a>
                <a class="btn btn-outline-light" href="/product#products" data-bs-dismiss="offcanvas">About</a>
                <a class="btn btn-outline-light" href="/catalog" data-bs-dismiss="offcanvas">Catalog</a>
                <a class="btn btn-success" href="/product#contact" data-bs-dismiss="offcanvas">REQUEST INFO</a>

                <!-- ‚úÖ Admin login (mobile) -->
                <button class="btn btn-outline-light"
                        type="button"
                        data-bs-dismiss="offcanvas"
                        @onclick="OpenAdminLogin">
                    Admin Login
                </button>
            </div>
        </div>
    </div>

    @* <!-- HERO (mini) -->
    <section class="hero hero-mini">
        <div class="container-xl hero-inner">
            <div class="hero-copy">
                <div class="hero-kicker">Catalog</div>
                <h1 class="hero-title">@((category is null) ? "PRODUCTS" : category.Name.ToUpper())</h1>
                <p class="hero-subtitle">
                    @((category is null)
                        ? "Browse products in this category."
                        : (!string.IsNullOrWhiteSpace(category.Description) ? category.Description : "Browse products in this category."))
                </p>

                <div class="hero-badges">
                    <span class="badge-pill">Clean</span>
                    <span class="badge-pill">Fast</span>
                    <span class="badge-pill">Medical-grade</span>
                </div>

                <div class="mt-3">
                    <a class="btn btn-outline-light btn-min" href="/catalog">‚Üê Back to categories</a>
                </div>
            </div>
        </div>
    </section> *@

    <!-- LIST -->
    <section class="cards">
        <div class="container-xl">

            <div class="section-head section-head-row">
                <div>
                    <div class="admin-kicker">Catalog</div>

                    <h2 class="section-title">
                        @((category is null) ? "Products" : category.Name)
                    </h2>

                    <div class="section-desc">
                        @((category is null)
                            ? "Browse products in this category."
                            : (!string.IsNullOrWhiteSpace(category.Description)
                                ? category.Description
                                : "Browse products in this category."))
                    </div>

                    <div class="mt-2">
                        <a class="btn btn-outline-light btn-sm btn-min" href="/catalog">
                            ‚Üê Back to categories
                        </a>
                    </div>
                </div>

                <div class="catalog-tools">
                    <input class="form-control input-min catalog-search"
                        placeholder="Search products..."
                        @bind="search"
                        @bind:event="oninput" />
                </div>
            </div>


            @if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="alert alert-danger my-3">@error</div>
            }

            @if (loading && products.Count == 0)
            {
                <div class="muted">Loading products...</div>
            }
            else if (filteredProducts.Count == 0)
            {
                <div class="muted">No products found in this category.</div>
            }
            else
            {
                <div class="row g-4">
                    @foreach (var p in filteredProducts)
                    {
                        <div class="col-12 col-md-4">
                            <div class="cat-card catalog-card">

                                <div class="cat-img">
                                    <img src="@GetProductCoverSrc(p)" alt="@p.Name" />
                                </div>

                                <div class="cat-body">
                                    <div class="cat-title">@p.Name</div>

                                    <div class="cat-meta">
                                        @p.Price.ToString("N2")
                                    </div>

                                    <div class="cat-text">
                                        @(!string.IsNullOrWhiteSpace(p.Description)
                                            ? p.Description
                                            : "No description provided.")
                                    </div>

                                    <div class="cat-actions">
                                        <a class="cat-link" href="/product#contact">Contact ‚Üí</a>
                                    </div>
                                </div>

                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </section>

    <!-- FOOTER (reuse theme) -->
    <footer class="f2-footer">
    <div class="container-xl">

        <!-- TOP -->
        <div class="f2-top">

        <!-- Col 1: Logo / About -->
        <div class="f2-col">
            <img class="f2-brandmark" src="/images/logo.png" alt="CU Madical Logo" />

            <div class="f2-logo">CU Madical Co.,Ltd.</div>

            <p class="f2-desc">
            Made in Thailand Medical Device Equipments Mouting and designs.
            </p>
        </div>

        <!-- Col 2: Contact -->
        <div class="f2-col">
            <div class="f2-title">Contact</div>

            <div class="f2-list">
            <div class="f2-row">
                <span class="f2-ico">üìç</span>
                <span>3/38 M10 Ladsawai, Lumlukka, Pathumthanee 12150</span>
            </div>

            <div class="f2-row">
                <span class="f2-ico">‚òéÔ∏è</span>
                <a href="tel:+666979526414">+669-7952-6414</a>
            </div>

            <div class="f2-row">
                <span class="f2-ico">‚úâÔ∏è</span>
                <div class="f2-stack">
                <a href="mailto:cu.madical@hotmail.com">cu.madical@hotmail.com</a>
                <a href="mailto:info@cumadical.com">info@cumadical.com</a>
                </div>
            </div>

            <div class="f2-row">
                <span class="f2-ico">üßæ</span>
                <span>Tax ID: 0135552007025</span>
            </div>
            </div>
        </div>

        <!-- Col 3: Follow us -->
        <div class="f2-col">
            <div class="f2-title">Follow us</div>

            <div class="f2-social">
            <a class="f2-socialbtn" href="#" aria-label="Facebook">f</a>
            <a class="f2-socialbtn" href="#" aria-label="Twitter">t</a>
            <a class="f2-socialbtn" href="#" aria-label="Google">g</a>
            </div>

            <div class="f2-mini">
            <div>üí¨ Line: <strong>chater8</strong></div>
            <div>üíö WeChat: <strong>chater5</strong></div>
            </div>
        </div>

        </div><!-- /.f2-top -->
    </div><!-- /.container-xl -->

    <!-- BOTTOM BAR -->
    <div class="f2-bottom">
        <div class="container-xl f2-bottom-inner">
        <div class="f2-copy">¬© @DateTime.Now.Year CU Madical Co.,Ltd.</div>

        <div class="f2-nav">
            <a href="/product#home">Top</a>
            <button type="button"
                    class="f2-navlink-btn"
                    @onclick="OpenAdminLogin">
            Admin
            </button>
        </div>
        </div>
    </div>

    </footer>


</div>

@if (showAdminModal)
{
    <div class="blz-modal-backdrop" @onclick="CloseAdminLogin"></div>

    <div class="blz-modal" role="dialog" aria-modal="true">
        <div class="blz-modal-card">
            <div class="blz-modal-header">
                <div class="blz-modal-title">Admin Login</div>
                <button class="btn btn-sm btn-outline-secondary" @onclick="CloseAdminLogin" disabled="@loginLoading">‚úï</button>
            </div>

            <div class="blz-modal-body">
                @if (!string.IsNullOrWhiteSpace(loginError))
                {
                    <div class="alert alert-danger">@loginError</div>
                }

                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input class="form-control" @bind="loginUsername" @bind:event="oninput" disabled="@loginLoading" />
                </div>

                <div class="mb-2">
                    <label class="form-label">Password</label>
                    <input class="form-control" type="password" @bind="loginPassword" @bind:event="oninput" disabled="@loginLoading" />
                </div>
            </div>

            <div class="blz-modal-footer">
                <button class="btn btn-outline-secondary" @onclick="CloseAdminLogin" disabled="@loginLoading">Cancel</button>
                <button class="btn btn-success" @onclick="DoAdminLoginAsync" disabled="@loginLoading">
                    @(loginLoading ? "Signing in..." : "Sign in")
                </button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int CategoryId { get; set; }

    private bool loading;
    private string? error;

    private string search = "";

    private CategoryVm? category;
    private readonly List<ProductVm> products = new();

    // ---------- Admin login modal state ----------
    private bool showAdminModal;          // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    private string loginUsername = "";
    private string loginPassword = "";
    private bool loginLoading;
    private string? loginError;

    private string adminTargetUrl = "/admin";

    protected override async Task OnParametersSetAsync()
    {
        await LoadAsync();
    }

    private HttpClient CreateClient()
        => HttpClientFactory.CreateClient("Backend");

    private async Task LoadAsync()
    {
        loading = true;
        error = null;
        StateHasChanged();

        try
        {
            var client = CreateClient();

            // ‡πÇ‡∏´‡∏•‡∏î category (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô header)
            var cats = await client.GetFromJsonAsync<List<CategoryVm>>("api/catalog/categories") ?? new();
            category = cats.FirstOrDefault(x => x.Id == CategoryId);

            // ‡πÇ‡∏´‡∏•‡∏î products ‡∏Ç‡∏≠‡∏á category ‡∏ô‡∏µ‡πâ
            // ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ API ‡πÅ‡∏ö‡∏ö route: /categories/{id}/products
            var data = await client.GetFromJsonAsync<List<ProductVm>>($"api/catalog/categories/{CategoryId}/products?onlyActive=true");
            products.Clear();
            if (data is not null) products.AddRange(data);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private List<ProductVm> filteredProducts
        => products
            .Where(x =>
                string.IsNullOrWhiteSpace(search) ||
                (x.Name?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (x.Description?.Contains(search, StringComparison.OrdinalIgnoreCase) ?? false))
            .OrderBy(x => x.Name)
            .ToList();

    private string GetProductCoverSrc(ProductVm p)
    {
        // ‚úÖ ‡∏ñ‡πâ‡∏≤ API ‡∏™‡πà‡∏á cover ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
        if (!string.IsNullOrWhiteSpace(p.CoverBase64))
            return $"data:{p.CoverContentType};base64,{p.CoverBase64}";

        // fallback
        return "/images/product-placeholder.jpg";
    }

    // ---------- Admin login handlers (NO JS) ----------
    private void OpenAdminLogin()
    {
        loginError = null;
        loginUsername = "";
        loginPassword = "";
        showAdminModal = true;
    }

     private void CloseAdminLogin()
    {
        if (loginLoading) return;
        showAdminModal = false;
    }

    private async Task DoAdminLoginAsync()
    {
        loginLoading = true;
        loginError = null;

        try
        {
            var client = CreateClient();

            var resp = await client.PostAsJsonAsync("api/auth/login", new LoginRequestDto
            {
                Username = loginUsername,
                Password = loginPassword
            });

            if (!resp.IsSuccessStatusCode)
            {
                loginError = resp.StatusCode == System.Net.HttpStatusCode.Unauthorized
                    ? "Invalid username or password."
                    : $"Login failed: {(int)resp.StatusCode} {resp.ReasonPhrase}";
                return;
            }

            var data = await resp.Content.ReadFromJsonAsync<LoginResponseDto>();
            if (data is null || string.IsNullOrWhiteSpace(data.Token))
            {
                loginError = "Login failed: empty token.";
                return;
            }

            await LocalStorage.SetItemAsync("auth_token", data.Token);
            await LocalStorage.SetItemAsync("auth_role", data.Role);
            await LocalStorage.SetItemAsync("auth_username", data.Username);

            showAdminModal = false; // ‚úÖ ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏ö‡∏ö Blazor
            Nav.NavigateTo(adminTargetUrl);
        }
        catch (Exception ex)
        {
            loginError = ex.Message;
        }
        finally
        {
            loginLoading = false;
        }
    }



    private sealed class CategoryVm
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string? Type { get; set; }
        public string? Description { get; set; }
        public bool IsActive { get; set; }
        public int SortOrder { get; set; }
    }

    // ‚úÖ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‚Äúproduct+cover‚Äù (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏° API cover ‡πÅ‡∏•‡πâ‡∏ß)
    private sealed class ProductVm
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int? CategoryId { get; set; }
        public string? CategoryName { get; set; }
        public string? Description { get; set; }
        public decimal Price { get; set; }
        public bool IsActive { get; set; }

        // cover image (optional)
        public string? CoverBase64 { get; set; }
        public string? CoverContentType { get; set; }
    }

    private sealed class LoginRequestDto
    {
        public string Username { get; set; } = "";
        public string Password { get; set; } = "";
    }

    private sealed class LoginResponseDto
    {
        public string Token { get; set; } = "";
        public string Username { get; set; } = "";
        public string Role { get; set; } = "";
    }

}
